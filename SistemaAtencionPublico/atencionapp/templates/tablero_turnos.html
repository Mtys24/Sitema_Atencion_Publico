<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Tablero Santa Cruz - Sistema de Turnos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --muni-guinda: #7B1E33; 
            --muni-verde: #4a5d23; 
            --muni-dorado: #c5a059; 
        }
        
        body { 
            background-color: #f4f7ed; 
            font-family: 'Montserrat', sans-serif; 
            overflow: hidden; 
            height: 100vh;
        }

        #capa-activacion { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; 
            display: flex; justify-content: center; align-items: center; 
        }

        /* HEADER */
        header { 
            background: white; 
            border-bottom: 6px solid var(--muni-verde); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 10px 40px;
        }

        .logo-muni {
            height: 90px;
            width: auto;
            margin-right: 25px;
        }

        .main-call { 
            background: linear-gradient(135deg, var(--muni-guinda) 0%, #4a0e1c 100%); 
            color: white; 
            border-radius: 35px; 
            padding: 60px 20px; 
            text-align: center; 
            border: 6px solid var(--muni-dorado);
            box-shadow: 0 20px 40px rgba(123, 30, 51, 0.4);
            animation: pulse-border 2s infinite;
        }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(197, 160, 89, 0.6); }
            70% { box-shadow: 0 0 0 30px rgba(197, 160, 89, 0); }
            100% { box-shadow: 0 0 0 0 rgba(197, 160, 89, 0); }
        }

        .numero-grande { 
            font-size: 12rem; 
            font-weight: 900; 
            color: var(--muni-dorado); 
            line-height: 0.8; 
            text-shadow: 5px 5px 0px rgba(0,0,0,0.3);
            margin: 10px 0;
        }
        
        .modulo-grande { 
            font-size: 4rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 2px;
        }

        /* TARJETAS Y LISTAS */
        .card-atencion { 
            background: white; 
            border-radius: 25px; 
            height: calc(100vh - 280px); 
            padding: 20px; 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.05); 
        }
        
        .ticket-espera { 
            padding: 15px; 
            margin-bottom: 15px; 
            border-left: 10px solid var(--muni-verde); 
            background: #f8f9fa; 
            font-weight: 900; 
            font-size: 2.2rem; 
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-historial {
            border-left-color: var(--muni-dorado);
            padding: 15px 30px;
            background: white;
        }

        .vacio { 
            border: 4px dashed #d1d1d1; 
            border-radius: 35px; 
            height: 450px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: #bbb; 
            font-style: italic; 
            font-size: 2.2rem; 
            background: rgba(255,255,255,0.5);
        }
        
        #reloj { color: var(--muni-guinda); font-size: 3.5rem; }
    </style>
</head>
<body>

<audio id="timbre" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<div id="capa-activacion">
    <button class="btn btn-success btn-lg p-5 fw-bold shadow-lg" style="border-radius: 20px; font-size: 2.5rem;" onclick="iniciarTablero()">
        ACTIVAR SISTEMA
    </button>
</div>

<header class="d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Escudo_de_Santa_Cruz%2C_Chile.svg/500px-Escudo_de_Santa_Cruz%2C_Chile.svg.png" 
             alt="Muni Santa Cruz" class="logo-muni">
        <h1 class="display-4 mb-0 fw-bold" style="color:var(--muni-verde); letter-spacing: -2px;">SANTA CRUZ</h1>
    </div>
    <div id="reloj" class="font-monospace fw-bold mb-0">00:00:00</div>
</header>

<div class="container-fluid mt-4 px-5">
    <div class="row g-5">
        <div class="col-md-3">
            <h2 class="text-center fw-bold mb-3" style="color: var(--muni-verde)">EN COLA</h2>
            <div class="card-atencion" id="cola"></div>
        </div>

        <div class="col-md-6">
            <div id="llamado-principal">
                <div class="vacio">Esperando nuevos llamados...</div>
            </div>
            
            <div class="mt-4">
                <h2 class="text-center fw-bold mb-3" style="font-size: 1.8rem; color: #555;">LLAMADOS RECIENTES</h2>
                <div id="historial-llamados"></div>
            </div>
        </div>

        <div class="col-md-3">
            <h2 class="text-center fw-bold mb-3" style="color: #666;">ATENDIDOS</h2>
            <div class="card-atencion" id="atendidos" style="opacity:0.8"></div>
        </div>
    </div>
</div>

<script>
window.idsConocidos = new Set(); 
window.colaNuevos = []; 
window.procesando = false;

function iniciarTablero() {
    document.getElementById('capa-activacion').style.display = 'none';
    const t = document.getElementById('timbre');
    t.play().then(() => { t.pause(); t.currentTime = 0; });

    setInterval(actualizarReloj, 1000);
    setInterval(obtenerDatos, 2000); 
    setInterval(motorPrioridad, 500); 
}

function actualizarReloj() {
    const ahora = new Date();
    document.getElementById('reloj').innerText = ahora.toLocaleTimeString('es-CL', { hour12: false });
}

function obtenerDatos() {
    fetch("/api-tablero/?nocache=" + Date.now())
    .then(res => res.json())
    .then(data => {
        renderListas(data);
        if (data.en_atencion) {
            data.en_atencion.forEach(ticket => {
                const ticketId = parseInt(ticket.id);
                if (!window.idsConocidos.has(ticketId)) {
                    if (window.idsConocidos.size === 0) {
                        data.en_atencion.forEach(t => window.idsConocidos.add(parseInt(t.id)));
                    } else {
                        window.idsConocidos.add(ticketId);
                        window.colaNuevos.push(ticket);
                    }
                }
            });
        }
    });
}

function renderListas(data) {
    document.getElementById("cola").innerHTML = data.en_cola.slice(0, 5).map(t => 
        `<div class="ticket-espera"><span>${t.numero}</span></div>`).join('');
    
    document.getElementById("atendidos").innerHTML = data.atendidos.slice(0, 5).map(t => 
        `<div class="ticket-espera" style="font-size:1.8rem; border-left-color: #ccc; opacity:0.6;">${t.numero}</div>`).join('');
    
    const hist = [...data.en_atencion].reverse().slice(0, 2);
    document.getElementById("historial-llamados").innerHTML = hist.map(p => `
        <div class="ticket-espera ticket-historial shadow-sm">
            <span class="h1 fw-bold mb-0" style="color: var(--muni-guinda)">${p.numero}</span>
            <span class="h3 mb-0 text-muted fw-bold">MÓDULO ${p.modulo}</span>
        </div>`).join('');
}

async function motorPrioridad() {
    if (window.procesando || window.colaNuevos.length === 0) return;
    window.procesando = true;
    const ticket = window.colaNuevos.shift();

    const timbre = document.getElementById('timbre');
    timbre.currentTime = 0;
    try { await timbre.play(); } catch(e) {}

    document.getElementById("llamado-principal").innerHTML = `
        <div class="main-call">
            <div class="modulo-grande">MÓDULO ${ticket.modulo}</div>
            <div class="numero-grande">${ticket.numero}</div>
            <div class="mt-3 h2 fw-bold" style="color:rgba(255,255,255,0.85)">${ticket.tramite}</div>
        </div>`;

    await hablar(ticket.numero, ticket.modulo);

    setTimeout(() => {
        document.getElementById("llamado-principal").innerHTML = `<div class="vacio">Esperando nuevos llamados...</div>`;
        window.procesando = false;
    }, 7000); 
}

function hablar(numero, modulo) {
    return new Promise(resolve => {
        window.speechSynthesis.cancel();
        const numSeparado = String(numero).split('').join(' ');
        const msg = new SpeechSynthesisUtterance(`Ticket ${numSeparado}, módulo ${modulo}`);
        msg.lang = 'es-CL';
        msg.rate = 0.8;
        msg.onend = resolve;
        msg.onerror = resolve;
        setTimeout(resolve, 5000); 
        window.speechSynthesis.speak(msg);
    });
}
</script>
</body>
</html>