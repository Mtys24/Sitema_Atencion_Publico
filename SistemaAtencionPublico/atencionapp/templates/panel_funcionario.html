<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Panel Funcionario - Santa Cruz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --muni-guinda: #7B1E33;
            --muni-verde: #4a5d23;
            --bg-body: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --list-hover: #f1f3f0;
        }

        [data-theme="dark"] {
            --bg-body: #1a1c18;
            --card-bg: #242921;
            --text-main: #f8f9fa;
            --text-muted: #b0b5af;
            --muni-guinda: #d44d6a;
            --muni-verde: #a3b87e;
            --border-color: #3a4235;
            --list-hover: #2d3429;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            transition: background 0.3s, color 0.3s;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background-color: var(--card-bg);
            border-bottom: 4px solid var(--muni-verde);
            padding: 0.8rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            color: var(--text-main);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .scroll-container {
            height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .table { color: var(--text-main); margin-bottom: 0; }
        .table thead {
            position: sticky;
            top: 0;
            background-color: var(--muni-verde) !important;
            color: #fff;
            z-index: 10;
        }

        .row-prioridad {
            background-color: rgba(123, 30, 51, 0.08) !important;
            border-left: 6px solid var(--muni-guinda) !important;
        }
        [data-theme="dark"] .row-prioridad {
            background-color: rgba(212, 77, 106, 0.12) !important;
        }

        .list-group-item {
            background-color: transparent !important;
            color: var(--text-main) !important;
            border-color: var(--border-color) !important;
        }
        .list-group-item:hover {
            background-color: var(--list-hover) !important;
        }

        .atencion-box {
            border: 2px solid var(--muni-verde);
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(163, 184, 126, 0.05) 100%);
        }

        .ticket-actual-lg {
            font-family: 'Playfair Display', serif;
            font-size: 5rem;
            color: var(--muni-guinda);
            font-weight: 900;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .text-muted-custom { color: var(--text-muted) !important; }

        .scroll-container::-webkit-scrollbar { width: 8px; }
        .scroll-container::-webkit-scrollbar-thumb { background: var(--muni-verde); border-radius: 10px; }
    </style>
</head>

<body data-theme="light">

<header class="panel-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Escudo_de_Santa_Cruz%2C_Chile.svg/500px-Escudo_de_Santa_Cruz%2C_Chile.svg.png" height="45">
        <div>
            <h4 class="mb-0 fw-bold" style="font-family: 'Playfair Display', serif;">MÃ³dulo {{ funcionario.modulo.numero }}</h4>
        </div>
    </div>
    <div class="d-flex align-items-center gap-3">
        <button class="btn btn-outline-success btn-sm fw-bold" onclick="toggleTheme()">ðŸŒ“ CAMBIAR TEMA</button>
        <a href="{% url 'logout_funcionario' %}" class="btn btn-sm btn-outline-danger">Cerrar SesiÃ³n</a>
    </div>
</header>

<div class="container-fluid py-4 flex-grow-1">
    <div class="row g-4 h-100">
        
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 fw-bold" style="color: var(--muni-verde)">ðŸ“‹ Vecinos en Cola</h5>
                    <span id="contador-cola" class="badge rounded-pill bg-success">0 en espera</span>
                </div>
                <div class="scroll-container">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Ticket</th>
                                <th>Nombre</th>
                                <th>RUT</th>
                                <th>TrÃ¡mite</th>
                                <th class="text-center">AcciÃ³n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaTickets"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="d-flex flex-column gap-4 h-100">
                
                <div class="card atencion-box shadow-sm text-center p-4">
                    <h6 class="text-uppercase fw-bold text-muted-custom mb-3">En AtenciÃ³n Ahora</h6>
                    <div id="ticketEnAtencion"></div>
                </div>

                <div class="card flex-grow-1 shadow-sm overflow-hidden">
                    <div class="card-header bg-transparent fw-bold" style="color: var(--muni-verde)">âœ… ÃšLTIMOS ATENDIDOS</div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="ultimosAtendidos"></ul>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
function toggleTheme() {
    const body = document.body;
    const newTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    body.setAttribute('data-theme', newTheme);
}

function formatRut(rut) {
    if (!rut) return "N/A";
    let value = rut.replace(/[.-]/g, '');
    if (value.length < 2) return value;
    let cuerpo = value.slice(0, -1);
    let dv = value.slice(-1).toUpperCase();
    cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return cuerpo + "-" + dv;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function actualizarPanel(){
    const response = await fetch("/api-panel/");
    const data = await response.json();

    const ticketsOrdenados = data.tickets.sort((a, b) => b.prioridad - a.prioridad);

    const tablaTickets = document.getElementById("tablaTickets");
    const contador = document.getElementById("contador-cola");
    tablaTickets.innerHTML = "";
    contador.innerText = `${ticketsOrdenados.length} vecinos esperando`;

    if(ticketsOrdenados.length === 0){
        tablaTickets.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted-custom">No hay vecinos en espera</td></tr>`;
    } else {
        ticketsOrdenados.forEach(ticket => {
            const tr = document.createElement("tr");
            if(ticket.prioridad) tr.className = "row-prioridad";

            tr.innerHTML = `
                <td class="fw-bold fs-5" style="color:var(--muni-guinda)">${ticket.numero}</td>
                <td>
                    <div class="fw-bold">${ticket.nombre}</div>
                    ${ticket.prioridad ? '<span class="badge bg-danger" style="font-size:0.6rem">PREFERENCIAL</span>' : ''}
                </td>
                <td class="font-monospace small">${formatRut(ticket.rut)}</td>
                <td><small class="text-muted-custom">${ticket.tipo}</small></td>
                <td class="text-center">
                    <button class="btn btn-success btn-sm fw-bold rounded-pill px-3" onclick="llamarTicket(${ticket.id})">Llamar</button>
                </td>
            `;
            tablaTickets.appendChild(tr);
        });
    }

    const divAtencion = document.getElementById("ticketEnAtencion");
    if(data.en_atencion.id){
        divAtencion.innerHTML = `
            <div class="ticket-actual-lg">${data.en_atencion.numero}</div>
            <h4 class="fw-bold mb-1">${data.en_atencion.nombre}</h4>
            <div class="text-muted-custom font-monospace mb-3">${formatRut(data.en_atencion.rut)}</div>
            <button class="btn btn-danger w-100 py-3 fw-bold rounded-3" onclick="finalizarTicket(${data.en_atencion.id})">FINALIZAR TURNO</button>
        `;
    } else {
        divAtencion.innerHTML = "<div class='py-4'><p class='text-muted-custom'>Listo para nuevo ticket</p></div>";
    }

    const ulAtendidos = document.getElementById("ultimosAtendidos");
    ulAtendidos.innerHTML = data.ultimos_atendidos.slice(0, 8).map(t => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><b style="color:var(--muni-verde)">${t.numero}</b> - <span class="small">${t.nombre}</span></span>
            <small class="text-muted-custom">Finalizado</small>
        </li>
    `).join('') || '<li class="p-3 text-center small text-muted-custom">Sin actividad</li>';
}

function llamarTicket(ticketId){
    fetch(`/llamar/${ticketId}/`, { method: "POST", headers: {"X-CSRFToken": getCookie("csrftoken")} })
    .then(() => actualizarPanel());
}

function finalizarTicket(ticketId){
    fetch(`/finalizar/${ticketId}/`, { method: "POST", headers: {"X-CSRFToken": getCookie("csrftoken")} })
    .then(() => actualizarPanel());
}

setInterval(actualizarPanel, 4000);
actualizarPanel();
</script>

</body>
</html>